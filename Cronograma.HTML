<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Cronograma de Estudo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-gray-50 text-gray-800 h-screen flex overflow-hidden">

    <div id="sidebar-container"></div>

    <main class="flex-1 flex flex-col min-w-0 bg-gray-50 overflow-hidden">
        <header class="bg-white border-b border-gray-200 h-16 px-6 flex justify-between items-center shadow-sm shrink-0">
            <div>
                <h1 class="text-xl font-bold text-gray-800">Cronograma Semanal</h1>
                <p class="text-xs text-gray-500">Organize seus hor√°rios de estudo (Salvo na Nuvem)</p>
            </div>
            
            <button id="addRowBtn" class="bg-sky-600 hover:bg-sky-700 text-white px-4 py-2 rounded-lg text-sm font-medium shadow-sm transition flex items-center gap-2">
                <i class="fa-solid fa-plus"></i> Novo Hor√°rio
            </button>
        </header>

        <div class="flex-1 overflow-y-auto p-6 scroll-smooth">
            
            <div class="bg-white p-2 rounded-xl border border-gray-200 shadow-sm mb-4 flex flex-wrap items-center gap-2 sticky top-0 z-20">
                <div class="flex gap-1 pr-3 border-r border-gray-100">
                    <button id="boldBtn" class="tool-btn" title="Negrito (Ctrl+B)"><i class="fas fa-bold"></i></button>
                    <button id="underlineBtn" class="tool-btn" title="Sublinhado (Ctrl+U)"><i class="fas fa-underline"></i></button>
                </div>
                <div class="flex gap-2 items-center pr-3 border-r border-gray-100">
                    <div class="flex items-center gap-1" title="Cor do Texto">
                        <i class="fa-solid fa-font text-gray-400 text-xs"></i>
                        <input type="color" id="textColorPicker" value="#000000">
                    </div>
                    <button id="applyTextColorBtn" class="text-xs font-medium text-gray-600 hover:text-sky-600 px-2 py-1 rounded hover:bg-gray-100">Aplicar</button>
                    <div class="w-px h-6 bg-gray-100 mx-1"></div>
                    <div class="flex items-center gap-1" title="Cor de Fundo">
                        <i class="fa-solid fa-fill-drip text-gray-400 text-xs"></i>
                        <input type="color" id="fillColorPicker" value="#eef2ff">
                    </div>
                    <button id="applyFillBtn" class="text-xs font-medium text-gray-600 hover:text-sky-600 px-2 py-1 rounded hover:bg-gray-100">Pintar</button>
                </div>
                <div class="flex gap-1 pr-3 border-r border-gray-100">
                    <button id="alignLeftBtn" class="tool-btn"><i class="fas fa-align-left"></i></button>
                    <button id="alignCenterBtn" class="tool-btn"><i class="fas fa-align-center"></i></button>
                    <button id="alignRightBtn" class="tool-btn"><i class="fas fa-align-right"></i></button>
                </div>
                <div class="flex gap-2 items-center ml-auto">
                    <button id="multiSelectBtn" class="px-3 py-1.5 rounded text-xs font-bold border border-gray-200 text-gray-600 hover:bg-sky-50 hover:text-sky-600 hover:border-sky-200 transition">
                        <i class="fa-solid fa-check-double mr-1"></i> Multi-sele√ß√£o
                    </button>
                    <button id="undoBtn" class="tool-btn" title="Desfazer (Ctrl+Z)"><i class="fas fa-rotate-left"></i></button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md border border-gray-200 flex flex-col flex-1 overflow-hidden h-full min-h-[400px]">
                <div class="overflow-auto h-full relative"> 
                    <table class="schedule-table" id="scheduleTable">
                        <thead>
                            <tr>
                                <th class="w-24">Hor√°rio</th>
                                <th class="min-w-[120px]">Dom</th>
                                <th class="min-w-[120px]">Seg</th>
                                <th class="min-w-[120px]">Ter</th>
                                <th class="min-w-[120px]">Qua</th>
                                <th class="min-w-[120px]">Qui</th>
                                <th class="min-w-[120px]">Sex</th>
                                <th class="min-w-[120px]">S√°b</th>
                                <th class="w-16"><i class="fa-solid fa-gear"></i></th>
                            </tr>
                        </thead>
                        <tbody id="scheduleBody"></tbody>
                    </table>
                </div>
                
                <div id="loadingMessage" class="hidden text-center py-12 text-gray-400">
                    <i class="fa-solid fa-circle-notch fa-spin text-4xl mb-3 text-sky-500"></i>
                    <p>Carregando cronograma...</p>
                </div>

                <div id="emptyMessage" class="hidden text-center py-12 text-gray-400">
                    <i class="fa-regular fa-calendar text-4xl mb-3 opacity-50"></i>
                    <p>Nenhum hor√°rio cadastrado.</p>
                </div>
            </div>

            <div class="mt-4 flex justify-between items-center text-xs text-gray-500 px-2">
                <div id="saveIndicator" class="flex items-center gap-2">
                    <i class="fas fa-circle-notch fa-spin text-gray-400" id="saveIcon"></i>
                    <span id="saveStatus">Aguardando login...</span>
                </div>
                <div>Total de hor√°rios: <span id="totalRows" class="font-bold">0</span></div>
            </div>
            <div class="h-10"></div>
        </div>
    </main>

    <script type="module">
    console.log("üöÄ Iniciando Script Cronograma...");

    import { db, auth } from "./firebase-config.js";
    import { ref, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // Elementos DOM (Sele√ß√£o direta, pois type="module" j√° espera o DOM)
    const scheduleBody = document.getElementById('scheduleBody');
    const addRowBtn = document.getElementById('addRowBtn');
    const saveIndicator = document.getElementById('saveIndicator');
    const saveStatus = document.getElementById('saveStatus');
    const saveIcon = document.getElementById('saveIcon');
    const totalRowsElement = document.getElementById('totalRows');
    const emptyMessage = document.getElementById('emptyMessage');
    const loadingMessage = document.getElementById('loadingMessage');

    // Toolbar elements
    const boldBtn = document.getElementById('boldBtn');
    const underlineBtn = document.getElementById('underlineBtn');
    const textColorPicker = document.getElementById('textColorPicker');
    const fillColorPicker = document.getElementById('fillColorPicker');
    const applyFillBtn = document.getElementById('applyFillBtn');
    const applyTextColorBtn = document.getElementById('applyTextColorBtn');
    const alignLeftBtn = document.getElementById('alignLeftBtn');
    const alignCenterBtn = document.getElementById('alignCenterBtn');
    const alignRightBtn = document.getElementById('alignRightBtn');
    const multiSelectBtn = document.getElementById('multiSelectBtn');
    const undoBtn = document.getElementById('undoBtn');

    // Estado Global
    let scheduleData = []; 
    let currentUserUID = null;
    const undoStack = [];
    const UNDO_LIMIT = 50;
    let dragSrcIndex = null;
    let multiSelectMode = false;
    const selectedCells = new Set();
    let isMouseDownForSelect = false;

    // --- AUTHENTICATION ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            console.log("‚úÖ Cronograma: Usu√°rio detectado", user.email);
            currentUserUID = user.uid;
            setStatus('loading', 'Sincronizando...');
            loadFromFirebase();
        } else {
            console.log("‚ùå Cronograma: Sem usu√°rio");
            currentUserUID = null;
            scheduleData = [];
            renderTable([]);
            setStatus('error', 'Fa√ßa login para ver seu cronograma.');
        }
    });

    // --- HELPERS ---
    function cloneDeep(obj) { return JSON.parse(JSON.stringify(obj)); }
    
    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }

    function setStatus(type, msg) {
        if(!saveStatus || !saveIndicator) return;
        saveStatus.textContent = msg;
        saveIndicator.className = 'flex items-center gap-2';
        
        if(type === 'saving' || type === 'loading') {
            saveIndicator.classList.add('text-sky-500');
            saveIcon.className = 'fas fa-sync-alt fa-spin';
        } else if (type === 'saved') {
            saveIndicator.classList.add('text-green-600');
            saveIcon.className = 'fas fa-check-circle';
        } else if (type === 'error') {
            saveIndicator.classList.add('text-red-500');
            saveIcon.className = 'fas fa-exclamation-circle';
        } else {
            saveIndicator.classList.add('text-gray-400');
            saveIcon.className = 'fas fa-clock';
        }
    }

    // --- FIREBASE CRUD ---
    async function loadFromFirebase() {
        if (!currentUserUID) return;
        
        scheduleBody.innerHTML = '';
        loadingMessage.classList.remove('hidden');
        emptyMessage.classList.add('hidden');

        try {
            const snapshot = await get(ref(db, `users/${currentUserUID}/cronograma`));
            if (snapshot.exists()) {
                const data = snapshot.val();
                scheduleData = (data || []).map(r => ({
                    time: r.time || '',
                    days: r.days || Array(7).fill(''),
                    timeBg: r.timeBg||'', bg: r.bg||Array(7).fill(''),
                    timeColor: r.timeColor||'', color: r.color||Array(7).fill(''),
                    timeAlign: r.timeAlign||'', align: r.align||Array(7).fill('')
                }));
            } else {
                // Dados padr√£o se vazio
                scheduleData = [
                    { time: '08:00', days: ['Descanso', 'Portugu√™s', 'Matem√°tica', 'Direito Const.', 'Inform√°tica', 'Revis√£o', 'Simulado'], bg:[], color:[], align:[] },
                    { time: '14:00', days: ['Lazer', 'Dir. Admin', 'Racioc√≠nio', 'Dir. Penal', 'Atualidades', 'Lei Seca', 'Corre√ß√£o'], bg:[], color:[], align:[] }
                ];
                saveToFirebase(true); // Salva o padr√£o
            }
            loadingMessage.classList.add('hidden');
            renderTable(scheduleData);
            setStatus('saved', 'Carregado da nuvem');
        } catch (e) {
            console.error("Erro load:", e);
            loadingMessage.classList.add('hidden');
            setStatus('error', 'Erro ao carregar dados');
        }
    }

    async function saveToFirebase(silent = false) {
        if (!currentUserUID) return;
        if (!silent) setStatus('saving', 'Salvando na nuvem...');
        
        try {
            await set(ref(db, `users/${currentUserUID}/cronograma`), scheduleData);
            console.log("üíæ Cronograma salvo no Firebase!");
            if (!silent) setStatus('saved', 'Altera√ß√µes salvas');
        } catch (e) {
            console.error("Erro save:", e);
            setStatus('error', 'Erro ao salvar');
        }
    }
    
    const debouncedSave = debounce(saveToFirebase, 1500);

    // --- UNDO/REDO & STATE ---
    function pushSnapshot() {
        const snapshot = cloneDeep(scheduleData);
        if (undoStack.length > 0) {
            const last = undoStack[undoStack.length - 1];
            if (JSON.stringify(last) === JSON.stringify(snapshot)) return;
        }
        undoStack.push(snapshot);
        if (undoStack.length > UNDO_LIMIT) undoStack.shift();
    }

    function undo() {
        if (undoStack.length === 0) return;
        const prev = undoStack.pop();
        scheduleData = cloneDeep(prev);
        renderTable(scheduleData);
        saveToFirebase();
    }

    // --- SELE√á√ÉO ---
    function clearSelection() {
        selectedCells.forEach(div => div.classList.remove('selected-cell'));
        selectedCells.clear();
    }

    function toggleCell(div) {
        if (selectedCells.has(div)) {
            div.classList.remove('selected-cell');
            selectedCells.delete(div);
        } else {
            div.classList.add('selected-cell');
            selectedCells.add(div);
        }
    }

    // --- RENDER ---
    function renderTable(data) {
        scheduleBody.innerHTML = '';
        const rows = data || [];

        if (rows.length === 0) {
            emptyMessage.classList.remove('hidden');
            totalRowsElement.textContent = 0;
            return;
        }
        emptyMessage.classList.add('hidden');

        rows.forEach((row, rowIndex) => {
            const tr = document.createElement('tr');
            tr.setAttribute('data-row', rowIndex);

            // Coluna Hor√°rio
            const timeCell = document.createElement('td');
            timeCell.className = 'time-cell';
            if (row.timeBg) timeCell.style.backgroundColor = row.timeBg;
            
            const timeDiv = document.createElement('div');
            timeDiv.className = 'editable-content';
            timeDiv.contentEditable = true;
            timeDiv.dataset.row = rowIndex;
            timeDiv.dataset.col = 'time';
            timeDiv.innerHTML = row.time || '';
            if (row.timeColor) timeDiv.style.color = row.timeColor;
            if (row.timeAlign) timeDiv.style.textAlign = row.timeAlign;
            
            timeCell.appendChild(timeDiv);
            tr.appendChild(timeCell);

            // Colunas Dias (0 a 6)
            (row.days || Array(7).fill('')).forEach((html, dayIndex) => {
                const td = document.createElement('td');
                if (row.bg && row.bg[dayIndex]) td.style.backgroundColor = row.bg[dayIndex];
                
                const div = document.createElement('div');
                div.className = 'editable-content';
                div.contentEditable = true;
                div.dataset.row = rowIndex;
                div.dataset.col = String(dayIndex);
                div.innerHTML = html || '';
                if (row.color && row.color[dayIndex]) div.style.color = row.color[dayIndex];
                if (row.align && row.align[dayIndex]) div.style.textAlign = row.align[dayIndex];

                td.appendChild(div);
                tr.appendChild(td);
            });

            // Coluna A√ß√µes
            const actionCell = document.createElement('td');
            actionCell.className = 'action-cell';
            const actionWrap = document.createElement('div');
            actionWrap.className = 'action-wrap';

            const dragBtn = document.createElement('button');
            dragBtn.className = 'btn-action drag-handle';
            dragBtn.innerHTML = '<i class="fas fa-grip-vertical"></i>';
            dragBtn.draggable = true;
            dragBtn.dataset.row = rowIndex;

            const delBtn = document.createElement('button');
            delBtn.className = 'btn-action delete';
            delBtn.innerHTML = '<i class="fas fa-trash"></i>';
            delBtn.dataset.row = rowIndex;
            delBtn.onclick = () => deleteRow(rowIndex);

            actionWrap.appendChild(dragBtn);
            actionWrap.appendChild(delBtn);
            actionCell.appendChild(actionWrap);
            tr.appendChild(actionCell);
            scheduleBody.appendChild(tr);
        });

        totalRowsElement.textContent = rows.length;
        bindDragHandlers();
    }

    // --- ACTIONS ---
    function deleteRow(index) {
        pushSnapshot();
        scheduleData.splice(index, 1);
        renderTable(scheduleData);
        setStatus('saving', 'Salvando...');
        debouncedSave();
    }

    if(addRowBtn) {
        addRowBtn.addEventListener('click', () => {
            pushSnapshot();
            const newRow = {
                time: '00:00',
                days: Array(7).fill(''),
                timeBg: '', bg: Array(7).fill(''),
                timeColor: '', color: Array(7).fill(''),
                timeAlign: 'center', align: Array(7).fill('')
            };
            scheduleData.push(newRow);
            renderTable(scheduleData);
            setStatus('saving', 'Salvando...');
            debouncedSave();
        });
    }

    // --- EDIT EVENTS ---
    scheduleBody.addEventListener('input', (e) => {
        const el = e.target;
        if(!el.classList.contains('editable-content')) return;
        
        const row = el.dataset.row;
        const col = el.dataset.col;
        const val = el.innerHTML;
        
        if(col === 'time') scheduleData[row].time = val;
        else scheduleData[row].days[col] = val;
        
        setStatus('saving', 'Digitando...');
        debouncedSave();
    });

    scheduleBody.addEventListener('mousedown', (e) => {
        const el = e.target.closest('.editable-content');
        if(!el) return;
        if(multiSelectMode) {
            e.preventDefault(); 
            isMouseDownForSelect = true;
            toggleCell(el);
        } else if(e.ctrlKey) {
            e.preventDefault();
            toggleCell(el);
        } else {
            clearSelection();
        }
    });

    document.addEventListener('mouseup', () => isMouseDownForSelect = false);
    scheduleBody.addEventListener('mouseover', (e) => {
        if(!isMouseDownForSelect || !multiSelectMode) return;
        const el = e.target.closest('.editable-content');
        if(el && !selectedCells.has(el)) {
            el.classList.add('selected-cell');
            selectedCells.add(el);
        }
    });

    if(multiSelectBtn) {
        multiSelectBtn.addEventListener('click', () => {
            multiSelectMode = !multiSelectMode;
            if(multiSelectMode) {
                multiSelectBtn.classList.add('bg-sky-100', 'text-sky-700', 'border-sky-300');
            } else {
                multiSelectBtn.classList.remove('bg-sky-100', 'text-sky-700', 'border-sky-300');
                clearSelection();
            }
        });
    }

    // --- STYLES ---
    function applyStyle(action, value = null) {
        pushSnapshot();
        const targets = selectedCells.size > 0 ? Array.from(selectedCells) : [];
        
        if(targets.length === 0 && !value) {
            document.execCommand(action, false, null);
            return;
        }
        
        targets.forEach(el => {
            const row = el.dataset.row;
            const col = el.dataset.col;
            
            if(action === 'color') {
                el.style.color = value;
                if(col === 'time') scheduleData[row].timeColor = value;
                else scheduleData[row].color[col] = value;
            } else if(action === 'background') {
                const td = el.closest('td');
                if(td) td.style.backgroundColor = value;
                if(col === 'time') scheduleData[row].timeBg = value;
                else scheduleData[row].bg[col] = value;
            } else if(action === 'textAlign') {
                el.style.textAlign = value;
                if(col === 'time') scheduleData[row].timeAlign = value;
                else scheduleData[row].align[col] = value;
            }
        });

        if(targets.length > 0) {
            setStatus('saving', 'Salvando estilo...');
            debouncedSave();
        } else {
             document.execCommand(action);
        }
    }

    if(boldBtn) boldBtn.onclick = () => applyStyle('bold');
    if(underlineBtn) underlineBtn.onclick = () => applyStyle('underline');
    if(applyTextColorBtn) applyTextColorBtn.onclick = () => applyStyle('color', textColorPicker.value);
    if(applyFillBtn) applyFillBtn.onclick = () => applyStyle('background', fillColorPicker.value);
    if(alignLeftBtn) alignLeftBtn.onclick = () => applyStyle('textAlign', 'left');
    if(alignCenterBtn) alignCenterBtn.onclick = () => applyStyle('textAlign', 'center');
    if(alignRightBtn) alignRightBtn.onclick = () => applyStyle('textAlign', 'right');
    if(undoBtn) undoBtn.onclick = undo;

    // --- DRAG AND DROP ---
    function bindDragHandlers() {
        const handles = scheduleBody.querySelectorAll('.drag-handle');
        handles.forEach(h => {
            h.addEventListener('dragstart', (e) => {
                dragSrcIndex = Number(e.target.dataset.row);
                e.dataTransfer.effectAllowed = 'move';
                e.target.closest('tr').classList.add('dragging');
            });
            h.addEventListener('dragend', (e) => {
                e.target.closest('tr').classList.remove('dragging');
                document.querySelectorAll('.drop-target').forEach(r => r.classList.remove('drop-target'));
            });
        });
        scheduleBody.ondragover = (e) => {
            e.preventDefault();
            const tr = e.target.closest('tr');
            if(tr && !tr.classList.contains('dragging')) {
                document.querySelectorAll('.drop-target').forEach(r => r.classList.remove('drop-target'));
                tr.classList.add('drop-target');
            }
        };
        scheduleBody.ondrop = (e) => {
            e.preventDefault();
            const tr = e.target.closest('tr');
            if(!tr) return;
            const destIndex = Number(tr.dataset.row);
            if(dragSrcIndex !== null && dragSrcIndex !== destIndex) {
                pushSnapshot();
                const item = scheduleData.splice(dragSrcIndex, 1)[0];
                scheduleData.splice(destIndex, 0, item);
                renderTable(scheduleData);
                saveToFirebase();
            }
        };
    }
    
    console.log("‚úÖ Script carregado");
    </script>
    
    <script src="menu.js"></script>
</body>
</html>