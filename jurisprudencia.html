<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jurisprud√™ncia - Sistema de Estudos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <style>
        /* --- ESTILOS GERAIS DO CARD (EFEITO 3D/BISEL MODERNO) --- */
        .info-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            position: relative; overflow: hidden;
            border-top: 1px solid rgba(255, 255, 255, 0.8); border-left: 1px solid rgba(255, 255, 255, 0.8);
            border-bottom: 1px solid rgba(226, 232, 240, 0.6); border-right: 1px solid rgba(226, 232, 240, 0.6);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 10px 15px -3px rgba(0, 0, 0, 0.03), inset 0 1px 2px rgba(255, 255, 255, 0.6);
        }
        .info-card:hover {
            transform: translateY(-5px) scale(1.01); z-index: 10;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.08), 0 10px 10px -5px rgba(0, 0, 0, 0.04), inset 0 1px 1px rgba(255, 255, 255, 0.9);
        }
        .card-header-bar {
            background-color: rgba(248, 250, 252, 0.7); padding: 0.6rem; text-align: center;
            box-shadow: inset 0 -2px 4px rgba(0, 0, 0, 0.02), inset 0 1px 2px rgba(255, 255, 255, 0.5);
            border-bottom: 1px solid rgba(241, 245, 249, 0.8); backdrop-filter: blur(5px);
        }
        .card-action-btn {
            position: absolute; right: 8px; width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; opacity: 0; transition: all 0.2s ease-in-out; z-index: 20; cursor: pointer; color: #94a3b8; background: rgba(255, 255, 255, 0.8); box-shadow: 0 2px 4px rgba(0,0,0,0.05); backdrop-filter: blur(4px);
        }
        .info-card:hover .card-action-btn { opacity: 1; }
        .btn-delete-card { top: 8px; } .btn-delete-card:hover { background: #fee2e2; color: #ef4444; transform: scale(1.1); box-shadow: 0 4px 6px rgba(239, 68, 68, 0.2); }
        .btn-reset-card { top: 38px; } .btn-reset-card:hover { background: #e2e8f0; color: #334155; transform: rotate(-180deg) scale(1.1); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        /* --- ESTILOS DE REVIS√ÉO --- */
        .rev-container-modern {
            background-color: #f1f5f9; border-radius: 9999px; padding: 0.35rem; display: inline-flex; gap: 0.35rem;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.06), inset 0 1px 2px rgba(255,255,255,0.5); border-bottom: 1px solid rgba(255,255,255,0.8);
        }
        .rev-btn {
            width: 34px; height: 34px; border-radius: 50%; background: linear-gradient(145deg, #ffffff, #f1f5f9);
            color: #64748b; font-weight: 700; font-size: 0.9rem; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s; position: relative; border: 1px solid #e2e8f0;
            box-shadow: 0 2px 3px rgba(0,0,0,0.05), inset 0 1px 2px rgba(255,255,255,1);
        }
        .rev-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 5px rgba(0,0,0,0.08), inset 0 1px 2px rgba(255,255,255,1); color: #0f172a; }
        .rev-btn:active { transform: translateY(1px); box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }

        /* PALETA MONOCROM√ÅTICA (ATIVOS) */
        .btn-rev-active-1 { background: linear-gradient(145deg, #f1f5f9, #e2e8f0) !important; color: #334155 !important; border-color: #cbd5e1 !important; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1) !important;}
        .btn-rev-active-2 { background: linear-gradient(145deg, #e0f2fe, #bae6fd) !important; color: #0284c7 !important; border-color: #7dd3fc !important; box-shadow: inset 0 1px 3px rgba(2, 132, 199, 0.2) !important; }
        .btn-rev-active-3 { background: linear-gradient(145deg, #dbeafe, #93c5fd) !important; color: #1d4ed8 !important; border-color: #60a5fa !important; box-shadow: inset 0 1px 3px rgba(29, 78, 216, 0.2) !important; }
        .btn-rev-active-custom { background: linear-gradient(145deg, #e0e7ff, #a5b4fc) !important; color: #4338ca !important; border-color: #818cf8 !important; box-shadow: inset 0 1px 3px rgba(67, 56, 202, 0.2) !important; overflow: visible !important; }
        
        .btn-rev-active-custom::after {
            content: attr(data-level); position: absolute; top: -8px; right: -8px;
            background-color: #10b981; color: white; font-size: 10px; font-weight: 800; width: 18px; height: 18px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 10;
        }

        /* Texto Colorido */
        .text-rev-0 { color: #334155; text-shadow: 0 1px 0 rgba(255,255,255,0.8); }
        .text-rev-1 { color: #475569; } .text-rev-2 { color: #0284c7; } .text-rev-3 { color: #2563eb; } .text-rev-custom { color: #4f46e5; }

        /* --- OUTROS --- */
        .nav-tab { padding: 0 1rem; height: 100%; display: flex; align-items: center; gap: 0.5rem; color: #64748b; font-weight: 500; font-size: 0.875rem; border-bottom: 2px solid transparent; transition: all 0.2s; white-space: nowrap; }
        .nav-tab:hover { color: #0284c7; background-color: #f8fafc; } .nav-tab.active { color: #0284c7; border-bottom-color: #0284c7; background-color: #f0f9ff; }
        .modal-tab { padding: 10px 5px; cursor: pointer; border-bottom: 2px solid transparent; color: #6b7280; font-weight: 600; font-size: 0.85rem; }
        .modal-tab.active { color: #0284c7; border-bottom-color: #0284c7; } .modal-tab-danger.active { color: #dc2626; border-bottom-color: #dc2626; }
        .btn-del-court { margin-left: 8px; font-size: 10px; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.1); color: inherit; cursor: pointer; transition: all 0.2s; }
        .btn-del-court:hover { background: #ef4444; color: white; transform: scale(1.1); }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 h-screen flex overflow-hidden font-sans">

    <div id="sidebar-container"></div>

    <main class="flex-1 flex flex-col min-w-0 bg-gray-100 overflow-hidden">
        
        <header class="bg-white border-b border-gray-200 shadow-sm shrink-0 z-20">
            <div class="h-16 px-6 flex justify-between items-center border-b border-gray-100">
                <div>
                    <h1 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <i class="fa-solid fa-gavel text-sky-600"></i> Controle de Jurisprud√™ncia
                    </h1>
                </div>
                <div class="flex items-center gap-4 bg-gray-50 px-4 py-1.5 rounded-lg border border-gray-100 shadow-inner">
                    <div class="text-right">
                        <p id="labelProgress" class="text-[10px] text-gray-500 font-bold uppercase">Progresso (Geral)</p>
                        <p id="progressText" class="text-sm font-bold text-sky-700 leading-none">0%</p>
                    </div>
                    <div class="w-32 h-2 bg-gray-200 rounded-full overflow-hidden shadow-inner">
                        <div id="progressBar" class="h-full bg-sky-500 transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            <div class="h-12 px-6 flex justify-between items-center bg-white overflow-x-auto">
                <div class="flex gap-4 h-full">
                    <button id="nav-informativos" class="nav-tab active" onclick="mudarModo('informativos')"><i class="fa-solid fa-file-lines"></i> Informativos</button>
                    <button id="nav-sumulas" class="nav-tab" onclick="mudarModo('sumulas')"><i class="fa-solid fa-book-bookmark"></i> S√∫mulas</button>
                    <button id="nav-repetitivos" class="nav-tab" onclick="mudarModo('repetitivos')"><i class="fa-solid fa-star"></i> Repetitivos</button>
                    <button id="nav-ojs" class="nav-tab" onclick="mudarModo('ojs')"><i class="fa-solid fa-paragraph"></i> OJs e PNs</button>
                    <button id="nav-jur-teses" class="nav-tab" onclick="mudarModo('jur-teses')"><i class="fa-solid fa-scale-balanced"></i> Jur. Teses</button>
                </div>
                <button onclick="abrirModal()" class="w-9 h-9 rounded-full bg-gradient-to-br from-sky-50 to-sky-100 text-sky-600 hover:to-sky-200 transition shadow-sm flex items-center justify-center border border-sky-200 hover:shadow-md transform hover:-translate-y-0.5 flex-shrink-0" title="Gerenciar Itens">
                    <i class="fa-solid fa-gear text-lg"></i>
                </button>
            </div>
        </header>

        <div class="bg-gray-100/95 backdrop-blur-sm px-6 py-3 border-b border-gray-200/50 shadow-sm shrink-0 z-10 flex flex-wrap items-center justify-between gap-4">
            
            <div id="courtTabsContainer" class="flex bg-white/60 p-1.5 rounded-2xl gap-1 overflow-x-auto max-w-xl shadow-sm border border-gray-200/60"></div>

            <div class="flex items-center gap-3">
                
                <div class="flex items-center gap-2 bg-white px-3 py-1.5 rounded-xl border border-gray-200 shadow-sm">
                    <i class="fa-solid fa-filter text-gray-400 text-xs"></i>
                    <select id="filterStatus" onchange="window.gerarGrid()" class="bg-transparent border-none text-gray-600 text-xs font-bold focus:ring-0 outline-none cursor-pointer">
                        <option value="todos">Todos</option>
                        <option value="lidos">Lidos</option>
                        <option value="nao-lidos">N√£o Lidos</option>
                    </select>
                </div>

                <div class="flex items-center gap-2 bg-white px-3 py-1.5 rounded-xl border border-gray-200 shadow-sm">
                    <label class="text-[10px] font-bold text-gray-400 uppercase">Ano:</label>
                    <select id="anoSelect" onchange="mudarAno(this.value)" class="bg-transparent border-none text-gray-700 text-sm focus:ring-0 block outline-none font-bold cursor-pointer w-20"></select>
                </div>

                <button id="btnSort" onclick="window.toggleSort()" class="w-9 h-9 rounded-xl bg-white text-gray-500 border border-gray-200 shadow-sm hover:text-sky-600 hover:border-sky-200 flex items-center justify-center transition" title="Inverter Ordem">
                    <i class="fa-solid fa-arrow-down-9-1"></i>
                </button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-6 scroll-smooth bg-gray-100 relative">
            <div id="gridContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-8 pb-10"></div>
        </div>
    </main>

    <div id="configModal" class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center backdrop-blur-sm transition-all">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100 border border-white/50">
            <div class="bg-gray-50/80 px-6 py-4 border-b border-gray-100 flex justify-between items-center backdrop-blur-sm">
                <h3 id="modalTitle" class="text-lg font-bold text-gray-800">Gerenciar</h3>
                <button onclick="fecharModal()" class="text-gray-400 hover:text-red-500 transition-colors w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="flex border-b border-gray-100 px-2 bg-gray-50/30">
                <button id="tabNewCourt" onclick="switchModalTab('newCourt')" class="modal-tab flex-1 text-center">Novo Tribunal</button>
                <button id="tabSingle" onclick="switchModalTab('single')" class="modal-tab active flex-1 text-center">Um por Um</button>
                <button id="tabRange" onclick="switchModalTab('range')" class="modal-tab flex-1 text-center">V√°rios</button>
                <button id="tabReset" onclick="switchModalTab('reset')" class="modal-tab flex-1 text-center hover:text-red-500 transition">Resetar</button>
            </div>
            <div class="p-6 space-y-5 bg-white">
                <div id="commonFields">
                    <div class="mb-4"><label class="block text-xs font-bold text-gray-500 uppercase mb-1 pl-1">Tribunal</label><select id="inputTribunalSelect" class="w-full border border-gray-200 rounded-xl p-3 focus:ring-2 focus:ring-sky-200 focus:border-sky-400 bg-gray-50/50 transition shadow-sm"></select></div>
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1 pl-1">Ano</label><input type="number" id="inputAno" class="w-full border border-gray-200 rounded-xl p-3 focus:ring-2 focus:ring-sky-200 focus:border-sky-400 bg-gray-50/50 transition shadow-sm" placeholder="Ex: 2025"></div>
                </div>
                <div id="formNewCourt" class="hidden">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1 pl-1">Nome do Tribunal</label>
                    <input type="text" id="inputNewTribunalName" class="w-full border border-gray-200 rounded-xl p-3 focus:ring-2 focus:ring-sky-200 focus:border-sky-400 bg-white transition shadow-sm" placeholder="Sigla (Ex: TSE, TRT, STF)">
                    <p class="text-xs text-gray-400 mt-2 pl-2 flex items-center gap-1"><i class="fa-solid fa-circle-info"></i> O novo tribunal aparecer√° na aba atual.</p>
                </div>
                <div id="formSingle">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1 pl-1">N√∫mero</label>
                    <input type="number" id="inputNumSingle" class="w-full border border-gray-200 rounded-xl p-3 focus:ring-2 focus:ring-sky-200 focus:border-sky-400 bg-gray-50/50 transition shadow-sm" placeholder="Ex: 1135">
                </div>
                <div id="formRange" class="hidden grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1 pl-1">De (In√≠cio)</label><input type="number" id="inputNumStart" class="w-full border border-gray-200 rounded-xl p-3 focus:ring-2 focus:ring-sky-200 focus:border-sky-400 bg-gray-50/50 transition shadow-sm" placeholder="Ex: 1120"></div>
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1 pl-1">At√© (Fim)</label><input type="number" id="inputNumEnd" class="w-full border border-gray-200 rounded-xl p-3 focus:ring-2 focus:ring-sky-200 focus:border-sky-400 bg-gray-50/50 transition shadow-sm" placeholder="Ex: 1140"></div>
                </div>
                <div id="formReset" class="hidden">
                    <div class="bg-red-50 border border-red-100 rounded-2xl p-4 flex gap-3 items-start shadow-sm">
                        <div class="bg-red-100 p-2 rounded-full"><i class="fa-solid fa-triangle-exclamation text-red-500 text-lg"></i></div>
                        <div><h4 class="text-sm font-bold text-red-800">Aten√ß√£o!</h4><p class="text-xs text-red-700 mt-1 leading-relaxed">Esta a√ß√£o ir√° marcar como <strong>N√ÉO LIDO</strong> todos os itens do Tribunal e Ano selecionados.</p></div>
                    </div>
                </div>
                <button id="btnActionAdd" onclick="salvarDados()" class="w-full bg-gradient-to-br from-sky-500 to-sky-600 hover:from-sky-600 hover:to-sky-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-sky-200 transition mt-2 transform hover:-translate-y-0.5 active:translate-y-0"><i class="fa-solid fa-plus mr-2"></i> Adicionar</button>
                <button id="btnActionReset" onclick="executarReset()" class="hidden w-full bg-gradient-to-br from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-red-200 transition mt-2 transform hover:-translate-y-0.5 active:translate-y-0"><i class="fa-solid fa-eraser mr-2"></i> Resetar Leituras</button>
                <button id="btnActionCreate" onclick="criarTribunal()" class="hidden w-full bg-gradient-to-br from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-emerald-200 transition mt-2 transform hover:-translate-y-0.5 active:translate-y-0"><i class="fa-solid fa-check mr-2"></i> Criar Tribunal</button>
            </div>
        </div>
    </div>

    <script type="module">
        console.log("üöÄ Iniciando Script Jurisprud√™ncia (Fix & Filter)...");

        import { db, auth } from "./firebase-config.js";
        import { ref, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        let databases = {
            'informativos': { 'STF': {}, 'STJ': {} },
            'sumulas': { 'STF - Vinculante': {}, 'STF': {}, 'STJ': {} },
            'repetitivos': { 'STF': {}, 'STJ': {} },
            'ojs': { 'TST': {} },
            'jur-teses': { 'STJ': {} }
        };
        
        let leituras = {};
        let currentMode = 'informativos'; 
        let tribunalAtual = 'STF';
        let anoAtual = new Date().getFullYear().toString();
        let currentUserUID = null;
        let sortDesc = true; // Estado da ordena√ß√£o

        const cardTitles = {
            'informativos': 'INFORMATIVO',
            'sumulas': 'S√öMULA',
            'repetitivos': 'REPETITIVO',
            'ojs': 'OJ / PN',
            'jur-teses': 'JUR. TESES'
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserUID = user.uid;
                carregarDadosFirebase();
            } else {
                currentUserUID = null;
                const container = document.getElementById('gridContainer');
                if(container) container.innerHTML = '<div class="col-span-full text-center py-10 text-gray-400">Fa√ßa login para acessar.</div>';
            }
        });

        function getUserRef(path) {
            if(!currentUserUID) return null;
            return ref(db, `users/${currentUserUID}/jurisprudencia/${path}`);
        }

        async function carregarDadosFirebase() {
            if (!currentUserUID) return;
            try {
                const snapshot = await get(ref(db, `users/${currentUserUID}/jurisprudencia`));
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    if(data.databases) databases = data.databases;
                    
                    if(!databases['informativos']) databases['informativos'] = { 'STF': {}, 'STJ': {} };
                    if(!databases['sumulas']) databases['sumulas'] = { 'STF - Vinculante': {}, 'STF': {}, 'STJ': {} };
                    
                    if(data.leituras) leituras = data.leituras;
                }
                init(); 
            } catch (error) {
                console.error("Erro no carregamento:", error);
            }
        }

        async function salvarDb() {
            if(!currentUserUID) return alert("Voc√™ precisa estar logado.");
            try {
                await set(getUserRef('databases'), databases);
                renderTribunalTabs();
                carregarAnosNoSelect();
                gerarGrid();
            } catch (e) {
                console.error("Erro ao salvar DB:", e);
            }
        }

        async function salvarLeituras() { 
            if(!currentUserUID) return;
            try {
                await set(getUserRef('leituras'), leituras);
                gerarGrid(); 
            } catch (e) { console.error("Erro ao salvar leituras:", e); }
        }

        function init() {
            mudarModo(currentMode);
        }

        function mudarModo(modo) {
            currentMode = modo;
            document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.getElementById(`nav-${modo}`);
            if(activeBtn) activeBtn.classList.add('active');
            
            const dbRef = databases[currentMode] || {};
            const keys = Object.keys(dbRef);
            const priority = ['STF - Vinculante', 'STF', 'STJ', 'TST'];
            
            let found = false;
            for(let p of priority) {
                if(dbRef[p]) { tribunalAtual = p; found = true; break; }
            }
            if(!found && keys.length > 0) tribunalAtual = keys[0];
            else if (!found) tribunalAtual = 'STF';
            
            renderTribunalTabs();
            carregarAnosNoSelect();
            gerarGrid();
        }

        function criarTribunal() {
            const el = document.getElementById('inputNewTribunalName');
            const novoNome = el.value.trim().toUpperCase();
            if(!novoNome) return alert("Digite o nome.");
            
            if(!databases[currentMode]) databases[currentMode] = {};
            if(databases[currentMode][novoNome]) return alert("Tribunal j√° existe.");
            
            databases[currentMode][novoNome] = { '_keep': 1 };
            salvarDb();
            
            tribunalAtual = novoNome;
            el.value = '';
            window.fecharModal();
        }

        function adicionarUnico(tribunal, ano, numero) {
            if (!numero || !ano || !tribunal) return alert("Preencha todos os campos.");
            const dbRef = databases[currentMode];
            if (!dbRef[tribunal]) dbRef[tribunal] = {};
            if (!dbRef[tribunal][ano]) dbRef[tribunal][ano] = [];
            
            const n = parseInt(numero);
            if (!dbRef[tribunal][ano].includes(n)) {
                dbRef[tribunal][ano].push(n);
                tribunalAtual = tribunal; anoAtual = ano;
                salvarDb();
                return true;
            } else {
                alert("Item j√° existe."); return false;
            }
        }

        function adicionarFaixa(tribunal, ano, inicio, fim) {
            let i = parseInt(inicio), f = parseInt(fim);
            if (!i || !f || !ano || !tribunal) return alert("Preencha todos os campos.");
            if (i > f) [i, f] = [f, i];
            
            const dbRef = databases[currentMode];
            if (!dbRef[tribunal]) dbRef[tribunal] = {};
            if (!dbRef[tribunal][ano]) dbRef[tribunal][ano] = [];
            
            let count = 0;
            for (let x = i; x <= f; x++) {
                if (!dbRef[tribunal][ano].includes(x)) {
                    dbRef[tribunal][ano].push(x);
                    count++;
                }
            }
            if(count > 0) {
                tribunalAtual = tribunal; anoAtual = ano;
                salvarDb();
                alert(`${count} itens adicionados.`);
                return true;
            } else {
                alert("Nenhum item novo nesta faixa."); return false;
            }
        }

        function getId(num) {
            if (currentMode === 'informativos') return `${tribunalAtual}-${num}`;
            return `${currentMode}-${tribunalAtual}-${num}`;
        }

        function renderTribunalTabs() {
            const container = document.getElementById('courtTabsContainer');
            if(!container) return;
            container.innerHTML = '';
            
            const dbRef = databases[currentMode] || {};
            let keys = Object.keys(dbRef);
            const priority = ['STF - Vinculante', 'STF', 'STJ', 'TST'];
            
            keys.sort((a, b) => {
                const ia = priority.indexOf(a), ib = priority.indexOf(b);
                if (ia !== -1 && ib !== -1) return ia - ib;
                if (ia !== -1) return -1; if (ib !== -1) return 1;
                return a.localeCompare(b);
            });

            keys.forEach(nome => {
                const btn = document.createElement('button');
                const active = nome === tribunalAtual;
                
                btn.className = active 
                    ? "px-4 py-2 rounded-xl text-sm font-bold shadow-sm bg-white text-sky-700 border border-gray-200/50 flex items-center shrink-0" 
                    : "px-4 py-2 rounded-xl text-sm font-medium text-gray-500 hover:text-gray-700 hover:bg-white/60 border border-transparent flex items-center shrink-0";
                
                btn.onclick = () => window.mudarTribunal(nome);
                btn.innerHTML = `<span>${nome}</span>`;
                
                if (!['STF', 'STJ', 'TST', 'STF - Vinculante'].includes(nome)) {
                    const del = document.createElement('span');
                    del.className = 'btn-del-court ml-2';
                    del.innerHTML = '<i class="fa-solid fa-xmark"></i>';
                    del.onclick = (e) => window.excluirTribunal(nome, e);
                    btn.appendChild(del);
                }
                container.appendChild(btn);
            });
        }

        function carregarAnosNoSelect() {
            const select = document.getElementById('anoSelect');
            if(!select) return;
            const dbRef = databases[currentMode];
            
            select.innerHTML = '';
            // Op√ß√£o TODOS
            const optTodos = document.createElement('option');
            optTodos.value = "todos";
            optTodos.text = "Todos";
            select.appendChild(optTodos);
            
            if(!dbRef || !dbRef[tribunalAtual]) return;

            const anos = Object.keys(dbRef[tribunalAtual])
                .filter(year => year !== '_keep') 
                .sort((a,b)=>b-a);

            if(anos.length > 0) {
                anos.forEach(ano => {
                    const o = document.createElement('option'); o.value = ano; o.text = ano;
                    if(ano == anoAtual) o.selected = true;
                    select.appendChild(o);
                });
            } else {
                // Se n√£o tiver anos, seleciona 'todos' ou o ano atual padr√£o
                if(anoAtual !== 'todos') {
                   const o = document.createElement('option'); o.value = anoAtual; o.text = anoAtual;
                   o.selected = true; select.appendChild(o);
                }
            }
            if(select.value) anoAtual = select.value;
        }

        function mudarTribunal(t) { tribunalAtual = t; renderTribunalTabs(); carregarAnosNoSelect(); gerarGrid(); }
        function mudarAno(a) { anoAtual = a; gerarGrid(); }
        
        window.toggleSort = function() {
            sortDesc = !sortDesc;
            const btn = document.getElementById('btnSort');
            if(btn) btn.innerHTML = sortDesc ? '<i class="fa-solid fa-arrow-down-9-1"></i>' : '<i class="fa-solid fa-arrow-up-1-9"></i>';
            gerarGrid();
        }

        window.gerarGrid = function() {
            const container = document.getElementById('gridContainer');
            if(!container) return;
            container.innerHTML = '';
            
            const dbRef = databases[currentMode];
            if(!dbRef || !dbRef[tribunalAtual]) return;

            // 1. Coleta os Itens (Considerando Ano "Todos" ou Espec√≠fico)
            let rawList = [];
            
            if(anoAtual === 'todos') {
                // Pega de todos os anos dispon√≠veis
                const anos = Object.keys(dbRef[tribunalAtual]).filter(y => y !== '_keep');
                anos.forEach(ano => {
                    const itensAno = dbRef[tribunalAtual][ano] || [];
                    rawList = rawList.concat(itensAno);
                });
                // Remove duplicatas se houver (mesmo n√∫mero em anos diferentes √© raro, mas seguro previnir)
                rawList = [...new Set(rawList)];
            } else {
                rawList = dbRef[tribunalAtual][anoAtual] || [];
            }
            
            // 2. Filtros de Status
            const filterStatus = document.getElementById('filterStatus').value; // todos, lidos, nao-lidos
            let filteredList = rawList.filter(num => {
                const id = getId(num);
                const nivel = leituras[id] || 0;
                if(filterStatus === 'lidos') return nivel > 0;
                if(filterStatus === 'nao-lidos') return nivel === 0;
                return true;
            });

            // 3. Ordena√ß√£o
            filteredList.sort((a, b) => sortDesc ? b - a : a - b);
            
            const lp = document.getElementById('labelProgress');
            if(lp) lp.innerText = `Progresso (${cardTitles[currentMode]})`;

            if(filteredList.length === 0) {
                container.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center py-20 text-gray-400"><div class="bg-white p-5 rounded-full mb-4 shadow-sm border border-gray-100"><i class="fa-solid fa-folder-open text-4xl text-gray-300"></i></div><p class="font-medium text-lg text-gray-500">Nenhum item encontrado.</p></div>`;
                atualizarProgresso(0,0); return;
            }

            let totalLidosGeral = 0;
            // Para calcular o progresso, usamos a lista bruta ou filtrada? 
            // Geralmente progresso √© sobre o que est√° na tela ou sobre o ano selecionado.
            // Vamos calcular sobre o que est√° na tela (filtrado) para dar feedback din√¢mico.
            
            filteredList.forEach(num => {
                const id = getId(num);
                const nivel = leituras[id] || 0;
                if(nivel > 0) totalLidosGeral++;
                
                let txtColor = 'text-rev-0';
                if(nivel===1) txtColor='text-rev-1';
                else if(nivel===2) txtColor='text-rev-2';
                else if(nivel===3) txtColor='text-rev-3';
                else if(nivel>=4) txtColor='text-rev-custom';

                const card = document.createElement('div');
                card.className = "info-card rounded-[2rem] flex flex-col items-center justify-between relative group h-[190px]";
                
                card.innerHTML = `
                    <button class="card-action-btn btn-delete-card" onclick="window.excluirItem('${tribunalAtual}','${anoAtual === 'todos' ? encontrarAnoDoItem(num) : anoAtual}',${num},event)"><i class="fa-solid fa-trash-can"></i></button>
                    <button class="card-action-btn btn-reset-card" onclick="window.resetarLeitura('${id}',event)"><i class="fa-solid fa-rotate-left"></i></button>
                    <div class="card-header-bar w-full text-[10px] uppercase tracking-widest text-gray-400 font-bold py-2.5">${cardTitles[currentMode]}</div>
                    <div class="text-center flex-1 flex flex-col justify-center pb-2">
                        <span class="info-num text-5xl font-extrabold ${txtColor} leading-tight tracking-tight drop-shadow-sm">${num}</span>
                    </div>
                `;
                
                const revDiv = document.createElement('div');
                revDiv.className = "rev-container-modern mb-5";
                
                for(let i=1; i<=3; i++) {
                    const b = document.createElement('button');
                    let cls = 'rev-btn';
                    if(nivel>=i) cls += ` btn-rev-active-${i}`;
                    b.className = cls; b.innerText = i;
                    b.onclick = (e) => { e.stopPropagation(); window.setarNivel(id, i); };
                    revDiv.appendChild(b);
                }
                
                const bCust = document.createElement('button');
                let clsCust = 'rev-btn';
                if(nivel>3) { clsCust += ' btn-rev-active-custom'; bCust.setAttribute('data-level', nivel); }
                bCust.className = clsCust; bCust.innerText = '...';
                bCust.onclick = (e) => window.inputNivelPersonalizado(id, e);
                revDiv.appendChild(bCust);
                
                card.appendChild(revDiv);
                container.appendChild(card);
            });
            atualizarProgresso(totalLidosGeral, filteredList.length);
        }

        // Helper para achar o ano quando estamos no modo "Todos"
        function encontrarAnoDoItem(num) {
            const dbRef = databases[currentMode][tribunalAtual];
            for(let ano in dbRef) {
                if(ano === '_keep') continue;
                if(dbRef[ano].includes(num)) return ano;
            }
            return anoAtual; // fallback
        }

        function atualizarProgresso(lidos, total) {
            const p = total===0 ? 0 : Math.round((lidos/total)*100);
            const bar = document.getElementById('progressBar');
            const txt = document.getElementById('progressText');
            if(bar) {
                bar.style.width = `${p}%`;
                if(p===100) { bar.classList.remove('bg-sky-500'); bar.classList.add('bg-emerald-500'); }
                else { bar.classList.add('bg-sky-500'); bar.classList.remove('bg-emerald-500'); }
            }
            if(txt) txt.innerText = `${p}% (${lidos}/${total})`;
        }

        function executarReset() {
            const tribunalAlvo = document.getElementById('inputTribunalSelect').value;
            const anoAlvo = document.getElementById('inputAno').value;
            if(!tribunalAlvo || !anoAlvo) return alert("Selecione Tribunal e Ano.");
            
            const dbRef = databases[currentMode];
            if(!dbRef[tribunalAlvo] || !dbRef[tribunalAlvo][anoAlvo]) return alert("N√£o existem itens.");
            
            if(confirm(`Resetar leitura de TODOS os itens do ${tribunalAlvo} em ${anoAlvo}?`)) {
                const lista = dbRef[tribunalAlvo][anoAlvo]; 
                let count = 0;
                lista.forEach(num => { 
                    const id = (currentMode === 'informativos') ? `${tribunalAlvo}-${num}` : `${currentMode}-${tribunalAlvo}-${num}`;
                    if(leituras[id]) { delete leituras[id]; count++; } 
                });
                salvarLeituras(); 
                window.fecharModal();
                alert(`Leituras resetadas: ${count}`);
            }
        }

        function salvarDados() {
            const ano = document.getElementById('inputAno').value; 
            const tribunalAlvo = document.getElementById('inputTribunalSelect').value;
            const isSingle = document.getElementById('tabSingle').classList.contains('active'); 
            
            let sucesso = false;
            if(isSingle) { 
                const num = document.getElementById('inputNumSingle').value; 
                sucesso = adicionarUnico(tribunalAlvo, ano, num); 
            } else { 
                const start = document.getElementById('inputNumStart').value; 
                const end = document.getElementById('inputNumEnd').value; 
                sucesso = adicionarFaixa(tribunalAlvo, ano, start, end); 
            }
            
            if(sucesso) { 
                window.fecharModal(); 
                document.getElementById('inputNumSingle').value = ''; 
                document.getElementById('inputNumStart').value = ''; 
                document.getElementById('inputNumEnd').value = ''; 
            }
        }

        document.addEventListener('click', (e) => {
            const btn = e.target.closest('#btnLogout');
            if (btn) {
                e.preventDefault();
                if(confirm("Deseja realmente sair?")) {
                    signOut(auth).then(() => {
                        window.location.href = 'index.html';
                    }).catch((error) => {
                        console.error("Erro ao sair:", error);
                    });
                }
            }
        });

        window.salvarDados = salvarDados;
        window.executarReset = executarReset;
        window.criarTribunal = criarTribunal;
        window.mudarModo = mudarModo;
        window.mudarAno = mudarAno;
        window.mudarTribunal = mudarTribunal;
        
        window.abrirModal = function() {
            document.getElementById('configModal').classList.remove('hidden');
            // Se estiver em "todos", preenche com o ano corrente no modal, sen√£o o ano selecionado
            document.getElementById('inputAno').value = (anoAtual === 'todos') ? new Date().getFullYear() : anoAtual;
            
            const sel = document.getElementById('inputTribunalSelect');
            sel.innerHTML = '';
            
            const dbRef = databases[currentMode] || {};
            let keys = Object.keys(dbRef);
            const priority = ['STF - Vinculante', 'STF', 'STJ', 'TST'];
            keys.sort((a, b) => {
                const ia = priority.indexOf(a), ib = priority.indexOf(b);
                if (ia !== -1 && ib !== -1) return ia - ib;
                if (ia !== -1) return -1; if (ib !== -1) return 1;
                return a.localeCompare(b);
            });
            
            keys.forEach(t => {
                const o = document.createElement('option'); o.value = t; o.text = t;
                if(t === tribunalAtual) o.selected = true;
                sel.appendChild(o);
            });
            window.switchModalTab('single');
        };

        window.fecharModal = function() {
            document.getElementById('configModal').classList.add('hidden');
        };

        window.switchModalTab = function(tab) {
            document.querySelectorAll('.modal-tab').forEach(t => { t.classList.remove('active'); t.classList.remove('modal-tab-danger'); });
            const els = ['commonFields','formNewCourt','formSingle','formRange','formReset','btnActionAdd','btnActionReset','btnActionCreate'];
            els.forEach(id => document.getElementById(id).classList.add('hidden'));

            if(tab === 'newCourt') {
                document.getElementById('tabNewCourt').classList.add('active');
                document.getElementById('formNewCourt').classList.remove('hidden');
                document.getElementById('btnActionCreate').classList.remove('hidden');
            } else if(tab === 'reset') {
                document.getElementById('tabReset').classList.add('active', 'modal-tab-danger');
                document.getElementById('commonFields').classList.remove('hidden');
                document.getElementById('formReset').classList.remove('hidden');
                document.getElementById('btnActionReset').classList.remove('hidden');
            } else {
                document.getElementById(tab === 'single' ? 'tabSingle' : 'tabRange').classList.add('active');
                document.getElementById('commonFields').classList.remove('hidden');
                document.getElementById('btnActionAdd').classList.remove('hidden');
                if(tab === 'single') document.getElementById('formSingle').classList.remove('hidden');
                else { 
                    const fr = document.getElementById('formRange'); 
                    fr.classList.remove('hidden'); fr.classList.add('grid'); 
                }
            }
        };

        window.excluirItem = function(t, a, n, ev) {
            ev.stopPropagation();
            if(confirm(`Excluir item ${n}?`)) {
                // Se ano for 'todos' no filtro, 'a' vir√° preenchido pela fun√ß√£o helper
                if (a === 'todos') return alert("Erro ao identificar o ano do item.");

                databases[currentMode][t][a] = databases[currentMode][t][a].filter(x => x !== n);
                const id = (currentMode==='informativos') ? `${t}-${n}` : `${currentMode}-${t}-${n}`;
                if(leituras[id]) delete leituras[id];
                salvarLeituras(); salvarDb();
            }
        };

        window.resetarLeitura = function(id, ev) {
            ev.stopPropagation();
            if(confirm("Zerar leitura?")) { delete leituras[id]; salvarLeituras(); }
        };

        window.excluirTribunal = function(nome, ev) {
            ev.stopPropagation();
            if(confirm(`Excluir tribunal ${nome}?`)) {
                delete databases[currentMode][nome];
                mudarModo(currentMode); salvarDb();
            }
        };

        window.setarNivel = function(id, n) {
            if(navigator.vibrate) navigator.vibrate(20);
            leituras[id] = n; salvarLeituras();
        };

        window.inputNivelPersonalizado = function(id, ev) {
            ev.stopPropagation();
            const v = leituras[id] || 0;
            const inp = prompt("N√≠vel de leitura:", v>3 ? v : "");
            if(inp!==null) {
                const n = parseInt(inp);
                if(!isNaN(n) && n>0) { leituras[id]=n; salvarLeituras(); }
                else if(n===0) { delete leituras[id]; salvarLeituras(); }
            }
        };

    </script>
    
    <script src="menu.js"></script>
    </body>
</html>
