<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jurisprud√™ncia - Sistema de Estudos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <style>
        /* --- ESTILOS GERAIS DO CARD (EFEITO 3D/BISEL MODERNO) --- */
        .info-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            position: relative; overflow: hidden;
            border-top: 1px solid rgba(255, 255, 255, 0.8); border-left: 1px solid rgba(255, 255, 255, 0.8);
            border-bottom: 1px solid rgba(226, 232, 240, 0.6); border-right: 1px solid rgba(226, 232, 240, 0.6);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 10px 15px -3px rgba(0, 0, 0, 0.03), inset 0 1px 2px rgba(255, 255, 255, 0.6);
        }
        .info-card:hover {
            transform: translateY(-5px) scale(1.01); z-index: 10;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.08), 0 10px 10px -5px rgba(0, 0, 0, 0.04), inset 0 1px 1px rgba(255, 255, 255, 0.9);
        }
        .card-header-bar {
            background-color: rgba(248, 250, 252, 0.7); padding: 0.6rem; text-align: center;
            box-shadow: inset 0 -2px 4px rgba(0, 0, 0, 0.02), inset 0 1px 2px rgba(255, 255, 255, 0.5);
            border-bottom: 1px solid rgba(241, 245, 249, 0.8); backdrop-filter: blur(5px);
        }
        .card-action-btn {
            position: absolute; right: 8px; width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; opacity: 0; transition: all 0.2s ease-in-out; z-index: 20; cursor: pointer; color: #94a3b8; background: rgba(255, 255, 255, 0.8); box-shadow: 0 2px 4px rgba(0,0,0,0.05); backdrop-filter: blur(4px);
        }
        .info-card:hover .card-action-btn { opacity: 1; }
        .btn-delete-card { top: 8px; } .btn-delete-card:hover { background: #fee2e2; color: #ef4444; transform: scale(1.1); box-shadow: 0 4px 6px rgba(239, 68, 68, 0.2); }
        .btn-reset-card { top: 38px; } .btn-reset-card:hover { background: #e2e8f0; color: #334155; transform: rotate(-180deg) scale(1.1); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        /* --- ESTILOS DE REVIS√ÉO --- */
        .rev-container-modern {
            background-color: #f1f5f9; border-radius: 9999px; padding: 0.35rem; display: inline-flex; gap: 0.35rem;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.06), inset 0 1px 2px rgba(255,255,255,0.5); border-bottom: 1px solid rgba(255,255,255,0.8);
        }
        .rev-btn {
            width: 34px; height: 34px; border-radius: 50%; background: linear-gradient(145deg, #ffffff, #f1f5f9);
            color: #64748b; font-weight: 700; font-size: 0.9rem; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s; position: relative; border: 1px solid #e2e8f0;
            box-shadow: 0 2px 3px rgba(0,0,0,0.05), inset 0 1px 2px rgba(255,255,255,1);
        }
        .rev-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 5px rgba(0,0,0,0.08), inset 0 1px 2px rgba(255,255,255,1); color: #0f172a; }
        .rev-btn:active { transform: translateY(1px); box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }

        /* PALETA MONOCROM√ÅTICA (ATIVOS) */
        .btn-rev-active-1 { background: linear-gradient(145deg, #f1f5f9, #e2e8f0) !important; color: #334155 !important; border-color: #cbd5e1 !important; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1) !important;}
        .btn-rev-active-2 { background: linear-gradient(145deg, #e0f2fe, #bae6fd) !important; color: #0284c7 !important; border-color: #7dd3fc !important; box-shadow: inset 0 1px 3px rgba(2, 132, 199, 0.2) !important; }
        .btn-rev-active-3 { background: linear-gradient(145deg, #dbeafe, #93c5fd) !important; color: #1d4ed8 !important; border-color: #60a5fa !important; box-shadow: inset 0 1px 3px rgba(29, 78, 216, 0.2) !important; }
        .btn-rev-active-custom { background: linear-gradient(145deg, #e0e7ff, #a5b4fc) !important; color: #4338ca !important; border-color: #818cf8 !important; box-shadow: inset 0 1px 3px rgba(67, 56, 202, 0.2) !important; overflow: visible !important; }
        
        .btn-rev-active-custom::after {
            content: attr(data-level); position: absolute; top: -8px; right: -8px;
            background-color: #10b981; color: white; font-size: 10px; font-weight: 800; width: 18px; height: 18px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 10;
        }

        /* Texto Colorido */
        .text-rev-0 { color: #334155; text-shadow: 0 1px 0 rgba(255,255,255,0.8); }
        .text-rev-1 { color: #475569; } .text-rev-2 { color: #0284c7; } .text-rev-3 { color: #2563eb; } .text-rev-custom { color: #4f46e5; }

        /* --- OUTROS --- */
        .nav-tab { padding: 0 1rem; height: 100%; display: flex; align-items: center; gap: 0.5rem; color: #64748b; font-weight: 500; font-size: 0.875rem; border-bottom: 2px solid transparent; transition: all 0.2s; white-space: nowrap; }
        .nav-tab:hover { color: #0284c7; background-color: #f8fafc; } .nav-tab.active { color: #0284c7; border-bottom-color: #0284c7; background-color: #f0f9ff; }
        .modal-tab { padding: 10px 5px; cursor: pointer; border-bottom: 2px solid transparent; color: #6b7280; font-weight: 600; font-size: 0.85rem; }
        .modal-tab.active { color: #0284c7; border-bottom-color: #0284c7; } .modal-tab-danger.active { color: #dc2626; border-bottom-color: #dc2626; }
        .btn-del-court { margin-left: 8px; font-size: 10px; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.1); color: inherit; cursor: pointer; transition: all 0.2s; }
        .btn-del-court:hover { background: #ef4444; color: white; transform: scale(1.1); }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 h-screen flex overflow-hidden font-sans">

    <div id="sidebar-container"></div>

    <main class="flex-1 flex flex-col min-w-0 bg-gray-100 overflow-hidden">
        <header class="bg-white border-b border-gray-200 shadow-sm shrink-0 z-10">
            <div class="h-16 px-6 flex justify-between items-center border-b border-gray-100">
                <div>
                    <h1 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <i class="fa-solid fa-gavel text-sky-600"></i> Controle de Jurisprud√™ncia
                    </h1>
                </div>
                <div class="flex items-center gap-4 bg-gray-50 px-4 py-1.5 rounded-lg border border-gray-100 shadow-inner">
                    <div class="text-right">
                        <p id="labelProgress" class="text-[10px] text-gray-500 font-bold uppercase">Progresso (Geral)</p>
                        <p id="progressText" class="text-sm font-bold text-sky-700 leading-none">0%</p>
                    </div>
                    <div class="w-32 h-2 bg-gray-200 rounded-full overflow-hidden shadow-inner">
                        <div id="progressBar" class="h-full bg-sky-500 transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            <div class="h-12 px-6 flex justify-between items-center bg-white overflow-x-auto">
                <div class="flex gap-4 h-full">
                    <button id="nav-informativos" class="nav-tab active" onclick="mudarModo('informativos')"><i class="fa-solid fa-file-lines"></i> Informativos</button>
                    <button id="nav-sumulas" class="nav-tab" onclick="mudarModo('sumulas')"><i class="fa-solid fa-book-bookmark"></i> S√∫mulas</button>
                    <button id="nav-repetitivos" class="nav-tab" onclick="mudarModo('repetitivos')"><i class="fa-solid fa-star"></i> Repetitivos</button>
                    <button id="nav-ojs" class="nav-tab" onclick="mudarModo('ojs')"><i class="fa-solid fa-paragraph"></i> OJs e PNs</button>
                    <button id="nav-jur-teses" class="nav-tab" onclick="mudarModo('jur-teses')"><i class="fa-solid fa-scale-balanced"></i> Jur. Teses</button>
                </div>
                <button onclick="abrirModal()" class="w-9 h-9 rounded-full bg-gradient-to-br from-sky-50 to-sky-100 text-sky-600 hover:to-sky-200 transition shadow-sm flex items-center justify-center border border-sky-200 hover:shadow-md transform hover:-translate-y-0.5 flex-shrink-0" title="Gerenciar Itens">
                    <i class="fa-solid fa-gear text-lg"></i>
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-6 scroll-smooth bg-gray-100">
            <div class="bg-white/80 p-3 rounded-3xl border border-white/50 shadow-lg shadow-gray-200/50 mb-8 flex flex-wrap items-center justify-between gap-4 sticky top-0 z-10 backdrop-blur-xl">
                <div id="courtTabsContainer" class="flex bg-gray-100/80 p-1.5 rounded-2xl gap-1 overflow-x-auto max-w-2xl shadow-inner border border-gray-200/50"></div>
                <div class="flex items-center gap-3 bg-gray-50/80 px-3 py-2 rounded-2xl border border-gray-200/50 shadow-sm">
                    <label class="text-xs font-bold text-gray-400 uppercase">Ano:</label>
                    <select id="anoSelect" onchange="mudarAno(this.value)" class="bg-transparent border-none text-gray-700 text-sm focus:ring-0 block p-1 outline-none font-bold cursor-pointer"></select>
                </div>
            </div>

            <div id="gridContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-8">
                </div>
            <div class="h-10"></div>
        </div>
    </main>

    <div id="configModal" class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center backdrop-blur-sm transition-all">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100 border border-white/50">
            <div class="bg-gray-50/80 px-6 py-4 border-b border-gray-100 flex justify-between items-center backdrop-blur-sm">
                <h3 id="modalTitle" class="text-lg font-bold text-gray-800">Gerenciar</h3>
                <button onclick="fecharModal()" class="text-gray-400 hover:text-red-500 transition-colors w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="flex border-b border-gray-100 px-2 bg-gray-50/30">
                <button id="tabNewCourt" onclick="switchModalTab('newCourt')" class="modal-tab flex-1 text-center">Novo Tribunal</button>
                <button id="tabSingle" onclick="switchModalTab('single')" class="modal-tab active flex-1 text-center">Um por Um</button>
                <button id="tabRange" onclick="switchModalTab('range')" class="modal-tab flex-1 text-center">V√°rios</button>
                <button id="tabReset" onclick="switchModalTab('reset')" class="modal-tab flex-1 text-center hover:text-red-500 transition">Resetar</button>
            </div>
            <div class="p-6 space-y-5 bg-white">
                <div id="commonFields">
                    <div class="mb-4"><label class="block text-xs font-bold text-gray-500 uppercase mb-1 pl-1">Tribunal</label><select id="inputTribunalSelect" class="w-full border border-gray-200 rounded-xl p-3 focus:ring-2 focus:ring-sky-200 focus:border-sky-400 bg-gray-50/50 transition shadow-sm"></select></div>
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1 pl-1">Ano</label><input type="number" id="inputAno" class="w-full border border-gray-200 rounded-xl p-3 focus:ring-2 focus:ring-sky-200 focus:border-sky-400 bg-gray-50/50 transition shadow-sm" placeholder="Ex: 2025"></div>
                </div>
                <div id="formNewCourt" class="hidden">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1 pl-1">Nome do Tribunal</label>
                    <input type="text" id="inputNewTribunalName" class="w-full border border-gray-200 rounded-xl p-3 focus:ring-2 focus:ring-sky-200 focus:border-sky-400 bg-white transition shadow-sm" placeholder="Sigla (Ex: TSE, TRT, STF)">
                    <p class="text-xs text-gray-400 mt-2 pl-2 flex items-center gap-1"><i class="fa-solid fa-circle-info"></i> O novo tribunal aparecer√° na aba atual.</p>
                </div>
                <div id="formSingle">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1 pl-1">N√∫mero</label>
                    <input type="number" id="inputNumSingle" class="w-full border border-gray-200 rounded-xl p-3 focus:ring-2 focus:ring-sky-200 focus:border-sky-400 bg-gray-50/50 transition shadow-sm" placeholder="Ex: 1135">
                </div>
                <div id="formRange" class="hidden grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1 pl-1">De (In√≠cio)</label><input type="number" id="inputNumStart" class="w-full border border-gray-200 rounded-xl p-3 focus:ring-2 focus:ring-sky-200 focus:border-sky-400 bg-gray-50/50 transition shadow-sm" placeholder="Ex: 1120"></div>
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1 pl-1">At√© (Fim)</label><input type="number" id="inputNumEnd" class="w-full border border-gray-200 rounded-xl p-3 focus:ring-2 focus:ring-sky-200 focus:border-sky-400 bg-gray-50/50 transition shadow-sm" placeholder="Ex: 1140"></div>
                </div>
                <div id="formReset" class="hidden">
                    <div class="bg-red-50 border border-red-100 rounded-2xl p-4 flex gap-3 items-start shadow-sm">
                        <div class="bg-red-100 p-2 rounded-full"><i class="fa-solid fa-triangle-exclamation text-red-500 text-lg"></i></div>
                        <div><h4 class="text-sm font-bold text-red-800">Aten√ß√£o!</h4><p class="text-xs text-red-700 mt-1 leading-relaxed">Esta a√ß√£o ir√° marcar como <strong>N√ÉO LIDO</strong> todos os itens do Tribunal e Ano selecionados.</p></div>
                    </div>
                </div>
                <button id="btnActionAdd" onclick="salvarDados()" class="w-full bg-gradient-to-br from-sky-500 to-sky-600 hover:from-sky-600 hover:to-sky-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-sky-200 transition mt-2 transform hover:-translate-y-0.5 active:translate-y-0"><i class="fa-solid fa-plus mr-2"></i> Adicionar</button>
                <button id="btnActionReset" onclick="executarReset()" class="hidden w-full bg-gradient-to-br from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-red-200 transition mt-2 transform hover:-translate-y-0.5 active:translate-y-0"><i class="fa-solid fa-eraser mr-2"></i> Resetar Leituras</button>
                <button id="btnActionCreate" onclick="criarTribunal()" class="hidden w-full bg-gradient-to-br from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-emerald-200 transition mt-2 transform hover:-translate-y-0.5 active:translate-y-0"><i class="fa-solid fa-check mr-2"></i> Criar Tribunal</button>
            </div>
        </div>
    </div>

<script type="module">
        // Importa as configura√ß√µes centrais
        import { db, auth } from "./firebase-config.js";
        // Importa fun√ß√µes espec√≠ficas do banco de dados e autentica√ß√£o
        import { ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // === ESTADO GLOBAL ===
        let databases = {
            'informativos': { 'STF': {}, 'STJ': {} },
            'sumulas': { 'STF - Vinculante': {}, 'STF': {}, 'STJ': {} },
            'repetitivos': { 'STF': {}, 'STJ': {} },
            'ojs': { 'TST': {} },
            'jur-teses': { 'STJ': {} }
        };
        
        let leituras = {};
        let currentMode = 'informativos'; 
        let tribunalAtual = 'STF';
        let anoAtual = new Date().getFullYear().toString();
        let currentUserUID = null; // Armazena o ID do usu√°rio localmente

        // Mapeamento de T√≠tulos
        const cardTitles = {
            'informativos': 'INFORMATIVO',
            'sumulas': 'S√öMULA',
            'repetitivos': 'REPETITIVO',
            'ojs': 'OJ / PN',
            'jur-teses': 'JUR. TESES'
        };

        // EXPORTA FUN√á√ïES PARA O HTML (Necess√°rio em type="module")
        window.mudarModo = mudarModo;
        window.mudarAno = mudarAno;
        window.abrirModal = abrirModal;
        window.fecharModal = fecharModal;
        window.switchModalTab = switchModalTab;
        window.salvarDados = salvarDados;
        window.executarReset = executarReset;
        window.criarTribunal = criarTribunal;
        window.mudarTribunal = mudarTribunal;
        
        // === 1. MONITORAMENTO DE AUTENTICA√á√ÉO (CORRE√á√ÉO DO PROBLEMA) ===
        // Isso garante que o c√≥digo saiba quem √© o usu√°rio, independente de quando a p√°gina carregou
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("‚úÖ Jurisprud√™ncia: Usu√°rio detectado ->", user.email);
                currentUserUID = user.uid;
                carregarDadosFirebase();
            } else {
                console.log("‚ùå Jurisprud√™ncia: Nenhum usu√°rio logado.");
                currentUserUID = null;
                // Opcional: Redirecionar ou limpar a tela
                document.getElementById('gridContainer').innerHTML = '<div class="text-center p-10 text-gray-400">Fa√ßa login para ver seus dados.</div>';
            }
        });

        // === 2. FUN√á√ïES DO FIREBASE ===

        function getUserRef(path) {
            if(!currentUserUID) return null;
            // Caminho exato: users/ID_DO_USUARIO/jurisprudencia/database_ou_leitura
            return ref(db, `users/${currentUserUID}/jurisprudencia/${path}`);
        }

        async function carregarDadosFirebase() {
            if (!currentUserUID) return;

            // Feedback visual de carregamento
            const container = document.getElementById('gridContainer');
            if(container) container.innerHTML = '<div class="col-span-full text-center py-10"><i class="fa-solid fa-circle-notch fa-spin text-sky-500 text-3xl"></i><p class="mt-2 text-gray-400 font-medium">Buscando dados na nuvem...</p></div>';

            try {
                console.log("üì• Iniciando download dos dados...");
                const userRoot = ref(db, `users/${currentUserUID}/jurisprudencia`);
                const snapshot = await get(userRoot);
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    console.log("üì¶ Dados recebidos:", data);

                    if(data.databases) databases = data.databases;
                    // Garante que a estrutura b√°sica exista mesmo se o banco vier parcial
                    if(!databases['informativos']) databases['informativos'] = { 'STF': {}, 'STJ': {} };

                    if(data.leituras) leituras = data.leituras;
                } else {
                    console.log("‚ö†Ô∏è Nenhum dado encontrado na nuvem. Iniciando vazio.");
                }
                
                // Inicializa a interface
                init();
                
            } catch (error) {
                console.error("üö® Erro cr√≠tico ao baixar dados:", error);
                alert("Erro ao sincronizar. Verifique o console (F12) para detalhes.");
            }
        }

        async function salvarDb() {
            if(!currentUserUID) return alert("Erro: Usu√°rio n√£o identificado. Recarregue a p√°gina.");
            
            console.log("üì§ Salvando Banco de Dados...");
            try {
                await set(getUserRef('databases'), databases);
                console.log("‚úÖ Banco salvo com sucesso!");
                
                // Atualiza a tela ap√≥s salvar
                renderTribunalTabs(); 
                carregarAnosNoSelect(); 
                gerarGrid(); 
            } catch (e) {
                console.error("Erro ao salvar DB:", e);
                alert("Erro ao salvar no servidor.");
            }
        }

        async function salvarLeituras() { 
            if(!currentUserUID) return;
            console.log("hub: Salvando status de leitura...");
            try {
                await set(getUserRef('leituras'), leituras);
                gerarGrid();
            } catch (e) {
                console.error("Erro leituras:", e);
            }
        }

        // === L√ìGICA DE INTERFACE ===

        function init() {
            // Garante estrutura m√≠nima
            if (!databases['sumulas']) databases['sumulas'] = {};
            if (!databases['sumulas']['STF - Vinculante']) databases['sumulas']['STF - Vinculante'] = {};
            
            // Renderiza inicial
            mudarModo(currentMode);
        }

        function mudarModo(modo) {
            currentMode = modo;
            
            // Atualiza UI das Abas
            document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));
            const btnAtivo = document.getElementById(`nav-${modo}`);
            if(btnAtivo) btnAtivo.classList.add('active');
            
            // L√≥gica de Prioridade
            const dbRef = databases[currentMode] || {};
            const keys = Object.keys(dbRef);
            const priority = ['STF - Vinculante', 'STF', 'STJ', 'TST'];
            
            let found = false;
            for(let p of priority) {
                if(dbRef[p]) { tribunalAtual = p; found = true; break; }
            }
            if(!found && keys.length > 0) tribunalAtual = keys[0];
            else if (!found) tribunalAtual = 'STF'; // Fallback
            
            renderTribunalTabs();
            carregarAnosNoSelect();
            gerarGrid();
        }

        function criarTribunal() {
            const novoNome = document.getElementById('inputNewTribunalName').value.trim().toUpperCase();
            if(!novoNome) return alert("Digite o nome do tribunal.");
            if(!databases[currentMode]) databases[currentMode] = {}; // Previne erro se vazio
            if(databases[currentMode][novoNome]) return alert("Este tribunal j√° existe nesta aba.");
            
            databases[currentMode][novoNome] = {}; 
            salvarDb(); // Salva nuvem
            
            tribunalAtual = novoNome; 
            document.getElementById('inputNewTribunalName').value = ''; 
            fecharModal();
        }

        function adicionarUnico(tribunal, ano, numero) {
            if (!numero || !ano || !tribunal) return alert("Preencha todos os dados!");
            const dbRef = databases[currentMode];
            if (!dbRef[tribunal]) dbRef[tribunal] = {};
            if (!dbRef[tribunal][ano]) dbRef[tribunal][ano] = [];
            
            const numInt = parseInt(numero);
            if (!dbRef[tribunal][ano].includes(numInt)) {
                dbRef[tribunal][ano].push(numInt); 
                dbRef[tribunal][ano].sort((a, b) => b - a);
                tribunalAtual = tribunal; anoAtual = ano; 
                salvarDb(); // Salva nuvem
                return true;
            } else { alert(`Item ${numero} j√° existe!`); return false; }
        }

        function adicionarFaixa(tribunal, ano, inicio, fim) {
            if (!inicio || !fim || !ano || !tribunal) return alert("Preencha todos os dados!");
            if (parseInt(inicio) > parseInt(fim)) { let temp = inicio; inicio = fim; fim = temp; }
            const dbRef = databases[currentMode];
            if (!dbRef[tribunal]) dbRef[tribunal] = {};
            if (!dbRef[tribunal][ano]) dbRef[tribunal][ano] = [];
            
            let count = 0; 
            for (let i = parseInt(inicio); i <= parseInt(fim); i++) { 
                if (!dbRef[tribunal][ano].includes(i)) { dbRef[tribunal][ano].push(i); count++; } 
            }
            if(count > 0) { 
                dbRef[tribunal][ano].sort((a, b) => b - a); 
                tribunalAtual = tribunal; anoAtual = ano; 
                salvarDb(); // Salva nuvem
                alert(`${count} itens adicionados!`); return true; 
            } else { alert("Nenhum novo item."); return false; }
        }

        function getId(num) {
            if (currentMode === 'informativos') return `${tribunalAtual}-${num}`;
            return `${currentMode}-${tribunalAtual}-${num}`;
        }

        // Fun√ß√µes Window (A√ß√µes dos Cards)
        window.excluirItem = function(tribunal, ano, numero, event) {
            event.stopPropagation();
            if (confirm(`Excluir ${cardTitles[currentMode]} ${numero}?`)) {
                databases[currentMode][tribunal][ano] = databases[currentMode][tribunal][ano].filter(n => n !== numero);
                // Remove leitura associada tamb√©m
                const idLeitura = (currentMode === 'informativos') ? `${tribunal}-${numero}` : `${currentMode}-${tribunal}-${numero}`;
                if (leituras[idLeitura]) delete leituras[idLeitura];
                
                salvarLeituras(); // Salva nuvem
                salvarDb(); // Salva nuvem
            }
        }

        window.resetarLeitura = function(id, event) {
            event.stopPropagation();
            if(confirm("Zerar a leitura deste item?")) { delete leituras[id]; salvarLeituras(); }
        }

        window.excluirTribunal = function(nome, event) {
            event.stopPropagation();
            if(confirm(`Excluir tribunal "${nome}" e todos os seus itens desta aba?`)) {
                delete databases[currentMode][nome];
                mudarModo(currentMode); 
                salvarDb();
            }
        }

        window.setarNivel = function(id, nivelAlvo) {
            if (navigator.vibrate) navigator.vibrate(20);
            leituras[id] = nivelAlvo; salvarLeituras();
        }
        
        window.inputNivelPersonalizado = function(id, event) {
            event.stopPropagation();
            const valorAtual = leituras[id] || 0;
            const input = prompt("Quantas vezes voc√™ leu este item?", valorAtual > 3 ? valorAtual : "");
            if (input !== null) {
                const num = parseInt(input);
                if (!isNaN(num) && num > 0) { leituras[id] = num; salvarLeituras(); } 
                else if (num === 0) { delete leituras[id]; salvarLeituras(); }
            }
        }

        function executarReset() {
            const tribunalAlvo = document.getElementById('inputTribunalSelect').value;
            const anoAlvo = document.getElementById('inputAno').value;
            if(!tribunalAlvo || !anoAlvo) return alert("Selecione Tribunal e Ano.");
            
            const dbRef = databases[currentMode];
            if(!dbRef[tribunalAlvo] || !dbRef[tribunalAlvo][anoAlvo]) return alert("N√£o existem itens para este per√≠odo.");
            
            if(confirm(`ATEN√á√ÉO: Resetar leitura de TODOS os itens do ${tribunalAlvo} em ${anoAlvo}?`)) {
                const lista = dbRef[tribunalAlvo][anoAlvo]; 
                let count = 0;
                lista.forEach(num => { 
                    const id = (currentMode === 'informativos') ? `${tribunalAlvo}-${num}` : `${currentMode}-${tribunalAlvo}-${num}`;
                    if(leituras[id]) { delete leituras[id]; count++; } 
                });
                salvarLeituras(); 
                fecharModal();
                if(tribunalAtual === tribunalAlvo && anoAtual === anoAlvo) gerarGrid();
                alert(`Leituras resetadas: ${count}`);
            }
        }

        // --- RENDERIZA√á√ÉO ---
        function renderTribunalTabs() { 
            const container = document.getElementById('courtTabsContainer'); 
            if(!container) return;
            container.innerHTML = '';
            
            const dbRef = databases[currentMode] || {};
            let keys = Object.keys(dbRef);
            
            const priority = ['STF - Vinculante', 'STF', 'STJ', 'TST'];
            keys.sort((a, b) => {
                const idxA = priority.indexOf(a); const idxB = priority.indexOf(b);
                if (idxA !== -1 && idxB !== -1) return idxA - idxB;
                if (idxA !== -1) return -1; if (idxB !== -1) return 1;
                return a.localeCompare(b);
            });

            keys.forEach(nome => {
                const btn = document.createElement('button'); const isActive = nome === tribunalAtual;
                btn.className = isActive ? "px-4 py-2 rounded-xl text-sm font-bold shadow-sm bg-white text-sky-700 transition whitespace-nowrap flex items-center border border-gray-200/50" : "px-4 py-2 rounded-xl text-sm font-medium text-gray-500 hover:text-gray-700 transition whitespace-nowrap flex items-center hover:bg-white/60 border border-transparent";
                btn.onclick = () => mudarTribunal(nome); btn.innerHTML = `<span>${nome}</span>`;
                
                const protectedCourts = ['STF', 'STJ', 'TST', 'STF - Vinculante'];
                if (!protectedCourts.includes(nome)) { 
                    const btnDel = document.createElement('span'); btnDel.className = 'btn-del-court'; btnDel.innerHTML = '<i class="fa-solid fa-xmark"></i>'; 
                    btnDel.onclick = (e) => excluirTribunal(nome, e); btn.appendChild(btnDel); 
                }
                container.appendChild(btn);
            });
        }

        function carregarAnosNoSelect() { 
            const select = document.getElementById('anoSelect');
            if(!select) return;

            const dbRef = databases[currentMode];
            if(!dbRef || !dbRef[tribunalAtual]) { 
                select.innerHTML = '<option value="">-</option>'; 
                return; 
            }
            
            const anosExistentes = Object.keys(dbRef[tribunalAtual]).sort((a, b) => b - a);
            
            select.innerHTML = ''; 
            if(anosExistentes.length === 0) {
                 const opt = document.createElement('option'); opt.value = anoAtual; opt.text = anoAtual; select.appendChild(opt);
            } else {
                anosExistentes.forEach(ano => { 
                    const opt = document.createElement('option'); opt.value = ano; opt.text = ano; 
                    if (ano == anoAtual) opt.selected = true; select.appendChild(opt); 
                }); 
            }
            if(select.value) anoAtual = select.value;
        }

        function mudarTribunal(tribunal) { tribunalAtual = tribunal; renderTribunalTabs(); carregarAnosNoSelect(); gerarGrid(); }
        function mudarAno(ano) { anoAtual = ano; gerarGrid(); }

        function gerarGrid() {
            const container = document.getElementById('gridContainer'); 
            if(!container) return;
            container.innerHTML = '';

            const dbRef = databases[currentMode];
            if(!dbRef) return;
            if(!dbRef[tribunalAtual]) dbRef[tribunalAtual] = {};
            
            const listaItens = dbRef[tribunalAtual][anoAtual] || [];

            // T√≠tulos din√¢micos
            const lblProgress = document.getElementById('labelProgress');
            if(lblProgress) lblProgress.innerText = `Progresso (${cardTitles[currentMode]})`;
            
            const modalT = document.getElementById('modalTitle');
            if(modalT) modalT.innerText = `Gerenciar ${cardTitles[currentMode]}`;

            if (listaItens.length === 0) {
                container.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center py-20 text-gray-400 bg-white/80 rounded-[2rem] border-2 border-dashed border-gray-300/50 shadow-sm backdrop-blur-sm"><div class="bg-gray-50 p-5 rounded-full mb-4 shadow-inner"><i class="fa-solid fa-folder-plus text-5xl text-gray-300/80"></i></div><p class="font-medium text-lg text-gray-500">Nenhum item aqui.</p><button onclick="abrirModal()" class="mt-4 px-8 py-3 bg-gradient-to-r from-sky-500 to-sky-600 text-white rounded-full hover:from-sky-600 hover:to-sky-700 font-bold transition shadow-lg shadow-sky-200/50 text-sm transform hover:-translate-y-0.5">Adicionar agora</button></div>`;
                atualizarProgresso(0, 0); return;
            }

            let lidosCount = 0;

            listaItens.forEach(num => {
                const id = getId(num);
                const nivel = leituras[id] || 0;
                if (nivel > 0) lidosCount++;

                let textColorClass = 'text-rev-0';
                if (nivel === 1) textColorClass = 'text-rev-1';
                else if (nivel === 2) textColorClass = 'text-rev-2';
                else if (nivel === 3) textColorClass = 'text-rev-3';
                else if (nivel >= 4) textColorClass = 'text-rev-custom';

                const card = document.createElement('div');
                card.className = `info-card rounded-[2rem] flex flex-col items-center justify-between relative group h-[190px]`;

                card.innerHTML = `
                    <button class="card-action-btn btn-delete-card" title="Excluir" onclick="excluirItem('${tribunalAtual}', '${anoAtual}', ${num}, event)"><i class="fa-solid fa-trash-can"></i></button>
                    <button class="card-action-btn btn-reset-card" title="Zerar Leitura" onclick="resetarLeitura('${id}', event)"><i class="fa-solid fa-rotate-left"></i></button>
                    <div class="card-header-bar w-full text-[10px] uppercase tracking-widest text-gray-400 font-bold py-2.5">${cardTitles[currentMode]}</div>
                    <div class="text-center flex-1 flex flex-col justify-center pb-2">
                        <span class="info-num text-5xl font-extrabold ${textColorClass} leading-tight tracking-tight drop-shadow-sm">${num}</span>
                    </div>
                `;

                const revContainer = document.createElement('div');
                revContainer.className = "rev-container-modern mb-5";

                for (let i = 1; i <= 3; i++) {
                    const btn = document.createElement('button');
                    let btnClass = 'rev-btn';
                    if (nivel >= i) {
                        if(nivel === 1) btnClass += ' btn-rev-active-1';
                        else if(nivel === 2) btnClass += ' btn-rev-active-2';
                        else if(nivel >= 3) btnClass += ' btn-rev-active-3';
                    }
                    btn.className = btnClass;
                    btn.innerText = i;
                    btn.onclick = (e) => { e.stopPropagation(); setarNivel(id, i); };
                    revContainer.appendChild(btn);
                }

                const btnCustom = document.createElement('button');
                let customText = '...'; let customClass = 'rev-btn';
                if (nivel > 3) { customClass += ' btn-rev-active-custom'; btnCustom.setAttribute('data-level', nivel); }
                btnCustom.className = customClass;
                btnCustom.innerText = customText; btnCustom.title = "Outro n√≠vel...";
                btnCustom.onclick = (e) => inputNivelPersonalizado(id, e);
                revContainer.appendChild(btnCustom);

                card.appendChild(revContainer);
                container.appendChild(card);
            });
            atualizarProgresso(lidosCount, listaItens.length);
        }

        function atualizarProgresso(lidos, total) {
            const porcentagem = total === 0 ? 0 : Math.round((lidos / total) * 100);
            const barra = document.getElementById('progressBar');
            const texto = document.getElementById('progressText');
            
            if(barra) {
                barra.style.width = `${porcentagem}%`;
                if (porcentagem === 100) { barra.classList.remove('bg-sky-500'); barra.classList.add('bg-emerald-500'); } 
                else { barra.classList.add('bg-sky-500'); barra.classList.remove('bg-emerald-500'); }
            }
            if(texto) texto.innerText = `${porcentagem}% (${lidos}/${total})`;
        }
    </script>
    
    <script src="menu.js"></script>
    <script type="module" src="firebase-config.js"></script>
    <script type="module" src="auth.js"></script>
</body>
</html>